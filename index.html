<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Image Overlay with Download</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Make canvas container responsive */
        #canvas-container {
            width: 100%;
            max-width: 800px;
            height: auto;
        }

        #canvas {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="w-full h-screen flex flex-col items-center justify-center">
        <div class="flex w-full flex-col items-center">
            <input type="file" id="imageInput" class="mb-4">
            <div id="canvas-container" class="relative w-full flex justify-center">
                <canvas id="canvas" class="border img-fluid"></canvas>
            </div>
            <button id="downloadButton" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">Download Image</button>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById("imageInput");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const downloadButton = document.getElementById("downloadButton");
        function resizeCanvas() {
            const container = document.getElementById("canvas-container");
            const aspectRatio = 4 / 3;  // Adjust as needed (4:3 ratio here)
            const containerWidth = container.offsetWidth;

            // Set canvas dimensions based on container width and aspect ratio
            canvas.width = containerWidth;
            canvas.height = containerWidth / aspectRatio;

            // Draw the base image again with the new dimensions
            if (baseImage.complete) {
                ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
            }
        }

        const baseImage = new Image();
        baseImage.src = "./WhatsApp Image 2024-10-28 at 1.29.52 PM PNG.png";
        baseImage.onload = () => {
            ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
            resizeCanvas();
        };

        let overlayImage = null;

        function overlayUserImage(userImageSrc) {
            overlayImage = new Image();
            overlayImage.src = userImageSrc;
            overlayImage.onload = () => {
                const overlayWidth = canvas.width * 0.8;
                const overlayHeight = canvas.height * 0.8;
                const centerX = (canvas.width - overlayWidth) / 2;
                const centerY = (canvas.height - overlayHeight) / 2;

                // Draw overlay image on canvas without saving to local storage
                // ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);  // Redraw base image
                ctx.drawImage(overlayImage, centerX, centerY, overlayWidth, overlayHeight); // Draw overlay
                ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
            };
        }

        imageInput.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('size', 'auto');

                try {
                    const response = await fetch('https://utsavgft.pythonanywhere.com/api/remove_background', {
                        method: 'POST',
                        body: formData,
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);

                        // Overlay user image with background removed
                        ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
                        overlayUserImage(url);
                    } else {
                        const errorText = await response.text();
                        console.error('Error:', response.status, errorText);
                        alert('Error: ' + response.status + ' - ' + errorText);
                    }
                } catch (error) {
                    console.error('Request failed:', error);
                    alert('Request failed: ' + error);
                }
            }
        });

        downloadButton.addEventListener("click", () => {
            if (overlayImage) {


                ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);  // Redraw base image
                // ctx.drawImage(overlayImage, centerX, centerY, overlayWidth, overlayHeight); // Draw overlay

                // Prepare for download
                const link = document.createElement("a");
                link.download = "combined-image.png";
                link.href = canvas.toDataURL("image/png");
                link.click();
            } else {
                alert("Please upload and process an image first.");
            }
        });

        window.addEventListener("resize", resizeCanvas);
    </script>
</body>

</html>